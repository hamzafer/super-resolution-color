<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Quality Assessment Test</title>
    <style>
        /* General Styles */
        body, html {
            margin: 0;
            padding: 0;
            min-height: 100%;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Grid Container */
        .grid-container {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            position: relative;
            flex: 1;
        }

        .grid-item {
            position: relative;
            width: 50%;
            padding-top: 50%; /* Maintains a square aspect ratio */
            overflow: hidden;
        }

        .grid-item img.super-res-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Use 'contain' to prevent cropping */
            background-color: #000; /* Optional: background for letterboxing */
            cursor: pointer;
            transition: transform 0.3s;
        }

        .grid-item img.super-res-img:hover {
            transform: scale(1.02);
        }

        /* Image Label */
        .image-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.5);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 16px;
        }

        /* Select Button on Images */
        .select-btn {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: #FFA500;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.9;
            transition: background-color 0.3s, opacity 0.3s;
        }
        .select-btn:hover {
            background-color: #FF8C00;
            opacity: 1;
        }

        /* Low-res image in the center */
        #low-res-img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 256px; /* Original low-res size */
            height: 256px;
            border: 2px solid #000;
            z-index: 1;
        }

        /* Selected image highlight */
        .selected {
            border: 5px solid red;
        }

        /* Submit Button Styling */
        .submit-button {
            text-align: center;
            margin: 20px 0;
        }
        .submit-button button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .submit-button button:hover {
            background-color: #45a049;
        }

        /* Instruction Overlay */
        .instruction-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 40;
            padding: 20px;
            box-sizing: border-box;
        }
        .instruction-overlay h2 {
            margin-bottom: 20px;
            font-size: 32px;
            text-align: center;
        }
        .instruction-overlay p {
            font-size: 18px;
            max-width: 600px;
            text-align: center;
            margin-bottom: 30px;
        }
        .instruction-overlay button {
            background-color: #008CBA;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .instruction-overlay button:hover {
            background-color: #007BB5;
        }

        /* Error Message */
        .error {
            color: red;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 25;
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 30;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.9); /* Black with opacity */
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
        }
        /* Close Button */
        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        /* Modal Select Button */
        .modal-select-button {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .modal-select-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <!-- Instruction Overlay -->
    <div id="instruction-overlay" class="instruction-overlay">
        <h2>Instructions</h2>
        <p>
            Welcome to the Image Quality Assessment Test. You will be presented with a low-resolution image at the center of the screen and four super-resolution images in the corners. Your task is to select the super-resolution image that you believe best enhances the original image's quality.
        </p>
        <p>
            To view a super-resolution image in detail, click on it to open it in full-screen mode. To select an image, click the "Select" button labeled with the image number. Once you have made your selection, click the "Submit" button at the bottom to proceed to the next image.
        </p>
        <button onclick="closeInstructions()">Start Test</button>
    </div>

    <div class="container">
        <!-- Grid Container -->
        <div class="grid-container">
            {% for img in image_set['super_res_images'] %}
            <div class="grid-item">
                <img id="super-res-img-{{ loop.index }}" class="super-res-img" src="{{ url_for('static', filename=img['path']) }}" data-model="{{ img['model'] }}" data-index="{{ loop.index }}" alt="Super Resolution Image {{ loop.index }}" onclick="openModal('{{ url_for('static', filename=img['path']) }}', '{{ img['model'] }}')">
                <!-- Image Label -->
                <div class="image-label">Image {{ loop.index }}</div>
                <!-- Select Button -->
                <button class="select-btn" onclick="selectImage('{{ img['model'] }}', {{ loop.index }})">Select Image {{ loop.index }}</button>
            </div>
            {% endfor %}
            <!-- Low-Resolution Image in Center -->
            <img id="low-res-img" src="{{ url_for('static', filename=image_set['low_res']) }}" alt="Low Resolution">
        </div>

        <!-- Submit Button -->
        <div class="submit-button">
            <form method="post">
                <input type="hidden" name="selected_model" id="selected_model">
                <input type="hidden" name="img_name" value="{{ image_set['low_res'].split('/')[-1] }}">
                <input type="hidden" name="index" value="{{ index }}">
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="myModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modal-img">
        <!-- Modal Select Button -->
        <button class="modal-select-button" onclick="selectImageFromModal()">Select This Image</button>
    </div>

    <!-- Error Message -->
    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    <script>
        // Function to open modal with the selected image
        function openModal(src, model) {
            var modal = document.getElementById("myModal");
            var modalImg = document.getElementById("modal-img");
            modal.style.display = "block";
            modalImg.src = src;
            modalImg.dataset.model = model;
        }

        // Function to close modal
        function closeModal() {
            var modal = document.getElementById("myModal");
            modal.style.display = "none";
        }

        // Close modal on Esc key
        document.addEventListener('keydown', function(event) {
            var modal = document.getElementById("myModal");
            if (event.key === "Escape") {
                modal.style.display = "none";
            }
        });

        // Function to select image from modal
        function selectImageFromModal() {
            var modalImg = document.getElementById("modal-img");
            var model = modalImg.dataset.model;
            selectImage(model);
            closeModal();
        }

        // Function to select image
        function selectImage(model, index) {
            // Remove previous selection
            var superResImages = document.querySelectorAll('.super-res-img');
            superResImages.forEach(function(img) {
                img.classList.remove('selected');
            });

            // Highlight the selected image
            var selectedImage = document.querySelector(`.super-res-img[data-model='${model}']`);
            if (selectedImage) {
                selectedImage.classList.add('selected');
            }

            // Set selected model in form
            document.getElementById('selected_model').value = model;
        }

        // Function to close instructions overlay
        function closeInstructions() {
            document.getElementById("instruction-overlay").style.display = "none";
            // Store a flag in sessionStorage
            sessionStorage.setItem('instructionsShown', 'true');
        }

        // Check if instructions have been shown before
        window.onload = function() {
            // Show instructions only if not shown before
            if (!sessionStorage.getItem('instructionsShown')) {
                document.getElementById("instruction-overlay").style.display = "flex";
            } else {
                document.getElementById("instruction-overlay").style.display = "none";
            }
        }
    </script>
</body>
</html>
